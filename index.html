<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>QuantumVault - Future Memory Preservation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Exo+2:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      :root {
        --primary: #00ffff;
        --secondary: #ff00ff;
        --accent: #ffff00;
        --dark: #0a0a0a;
        --darker: #000000;
        --light: #f0f0f0;
        --glass: rgba(255, 255, 255, 0.05);
        --glass-border: rgba(0, 255, 255, 0.2);
        --text-color: #fff;
        --bg-color: linear-gradient(
          135deg,
          #000000 0%,
          #0a0a0a 25%,
          #1a1a2e 50%,
          #16213e 75%,
          #0f3460 100%
        );
        --sidebar-bg: rgba(10, 10, 20, 0.7);
        --card-bg: rgba(20, 20, 40, 0.6);
        --input-bg: rgba(0, 0, 0, 0.6);
        --input-border: var(--glass-border);
        --button-bg: linear-gradient(45deg, var(--primary), var(--secondary));
        --button-text: #000;
        --modal-bg: rgba(5, 5, 15, 0.9);
        --message-own: linear-gradient(
          45deg,
          rgba(0, 255, 255, 0.2),
          rgba(255, 0, 255, 0.2)
        );
        --message-other: rgba(255, 255, 255, 0.1);
      }

      body.light-theme {
        --primary: #007bff;
        --secondary: #6f42c1;
        --accent: #fd7e14;
        --dark: #f8f9fa;
        --darker: #e9ecef;
        --light: #212529;
        --glass: rgba(0, 0, 0, 0.03);
        --glass-border: rgba(0, 0, 0, 0.1);
        --text-color: #333;
        --bg-color: linear-gradient(135deg, #f0f2f5, #e2e6ea);
        --sidebar-bg: rgba(255, 255, 255, 0.95);
        --card-bg: rgba(255, 255, 255, 0.95);
        --input-bg: rgba(255, 255, 255, 0.95);
        --input-border: #ced4da;
        --button-bg: linear-gradient(45deg, #007bff, #6f42c1);
        --button-text: #fff;
        --modal-bg: rgba(250, 250, 250, 0.95);
        --message-own: linear-gradient(45deg, #007bff, #6f42c1);
        --message-other: #e9ecef;
      }

      body.cyberpunk-theme {
        --primary: #ff00ff;
        --secondary: #00ffff;
        --accent: #ff0055;
        --dark: #150035;
        --text-color: #00ff00;
        --bg-color: linear-gradient(135deg, #0a001d, #1d004a);
        --card-bg: rgba(25, 5, 55, 0.85);
        --input-bg: rgba(0, 0, 0, 0.7);
      }

      body {
        font-family: "Exo 2", sans-serif;
        background: var(--bg-color);
        background-attachment: fixed;
        color: var(--text-color);
        overflow-x: hidden;
        position: relative;
        transition: background 0.5s ease;
        margin: 0;
        padding: 0;
        min-height: 100vh;
      }

      button,
      input,
      textarea,
      select {
        font-family: inherit;
      }

      .glass-morphism {
        background: var(--glass);
        backdrop-filter: blur(20px);
        border: 1px solid var(--glass-border);
        border-radius: 20px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      }

      .quantum-btn {
        background: var(--button-bg);
        border: none;
        color: var(--button-text);
        font-weight: 600;
        letter-spacing: 1px;
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-family: "Orbitron", monospace;
        text-transform: uppercase;
        position: relative;
        overflow: hidden;
      }

      .quantum-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
      }

      .quantum-card {
        background: var(--card-bg);
        border: 1px solid var(--glass-border);
        border-radius: 15px;
        position: relative;
        overflow: hidden;
        transition: all 0.3s ease;
        backdrop-filter: blur(10px);
      }

      .quantum-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
      }

      .quantum-input {
        background: var(--input-bg);
        border: 1px solid var(--input-border);
        border-radius: 8px;
        padding: 12px 15px;
        color: var(--text-color);
        transition: all 0.3s ease;
        font-family: "Exo 2", sans-serif;
        width: 100%;
      }

      .quantum-input:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(0, 255, 255, 0.3);
      }

      .theme-btn {
        padding: 8px 15px;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 500;
        background: var(--card-bg);
        color: var(--text-color);
        border: 1px solid var(--input-border);
      }

      .theme-btn.active {
        background: var(--button-bg);
        color: var(--button-text);
        border-color: transparent;
      }

      .setting-toggle {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 0;
        border-bottom: 1px solid var(--glass-border);
      }

      .switch {
        position: relative;
        display: inline-block;
        width: 50px;
        height: 26px;
      }

      .switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }

      .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: 0.4s;
        border-radius: 26px;
      }

      .slider:before {
        position: absolute;
        content: "";
        height: 18px;
        width: 18px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        transition: 0.4s;
        border-radius: 50%;
      }

      input:checked + .slider {
        background: var(--button-bg);
      }

      input:checked + .slider:before {
        transform: translateX(24px);
      }

      .app-layout {
        display: flex;
        min-height: 100vh;
      }

      .sidebar {
        width: 250px;
        background: var(--sidebar-bg);
        backdrop-filter: blur(15px);
        border-right: 1px solid var(--glass-border);
        padding: 20px;
        transition: all 0.3s ease;
        display: flex;
        flex-direction: column;
      }

      .logo-container {
        padding: 10px 0 30px;
        text-align: center;
      }

      .logo {
        font-family: "Orbitron", monospace;
        font-weight: 800;
        font-size: 28px;
        background: linear-gradient(45deg, var(--primary), var(--secondary));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 5px;
      }

      .nav-menu {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        gap: 5px;
      }

      .nav-item {
        padding: 12px 15px;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 10px;
        color: var(--text-color);
      }

      .nav-item:hover,
      .nav-item.active {
        background: var(--glass);
        color: var(--primary);
      }

      .user-profile-summary {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 0;
        border-top: 1px solid var(--glass-border);
        margin-top: auto;
      }

      .user-avatar {
        width: 38px;
        height: 38px;
        border-radius: 50%;
        background: linear-gradient(45deg, var(--primary), var(--secondary));
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: var(--darker);
        background-size: cover;
        background-position: center;
      }

      .user-info {
        flex-grow: 1;
      }

      .username {
        font-weight: 600;
        font-size: 14px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .user-status {
        font-size: 12px;
        opacity: 0.7;
      }

      .main-content {
        flex-grow: 1;
        padding: 20px;
        overflow-y: auto;
      }

      .section-header {
        margin-bottom: 25px;
      }

      .section-title {
        font-size: 32px;
        font-weight: 700;
        margin-bottom: 10px;
        font-family: "Orbitron", sans-serif;
        color: var(--primary);
      }

      .section-description {
        opacity: 0.8;
      }

      .content-section {
        display: none;
        animation: fadeIn 0.5s ease;
      }

      .content-section.active {
        display: block;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .loading-screen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: var(--darker);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        transition: opacity 0.5s ease;
      }

      .logo-lg {
        font-family: "Orbitron", monospace;
        font-weight: 900;
        font-size: 3.5rem;
        background: linear-gradient(
          45deg,
          var(--primary),
          var(--secondary),
          var(--accent)
        );
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 30px;
      }

      .spinner {
        width: 50px;
        height: 50px;
        border: 5px solid transparent;
        border-top: 5px solid var(--primary);
        border-right: 5px solid var(--secondary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .auth-container {
        max-width: 450px;
        width: 100%;
        padding: 30px;
        display: flex;
        flex-direction: column;
        gap: 25px;
      }

      .auth-tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
      }

      .auth-tab {
        flex: 1;
        text-align: center;
        padding: 12px;
        border-radius: 8px;
        background: transparent;
        border: 1px solid var(--input-border);
        color: var(--text-color);
        font-weight: 600;
        cursor: pointer;
      }

      .auth-tab.active {
        background: var(--button-bg);
        color: var(--button-text);
        border-color: transparent;
      }

      .messages-container {
        display: flex;
        height: calc(100vh - 150px);
        background: var(--card-bg);
        border-radius: 16px;
        overflow: hidden;
      }

      .conversations-list {
        width: 320px;
        border-right: 1px solid var(--glass-border);
        overflow-y: auto;
        display: flex;
        flex-direction: column;
      }

      .conversations-header {
        padding: 20px;
        border-bottom: 1px solid var(--glass-border);
      }

      .conversation-item {
        padding: 15px;
        transition: all 0.3s ease;
        border-bottom: 1px solid var(--glass-border);
        cursor: pointer;
      }

      .conversation-item:hover,
      .conversation-item.active {
        background: var(--glass);
      }

      .conversation-content {
        display: flex;
        gap: 12px;
        align-items: center;
      }

      .conversation-avatar {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        background: linear-gradient(45deg, var(--primary), var(--secondary));
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        color: var(--darker);
      }

      .conversation-name {
        font-weight: 600;
        margin-bottom: 3px;
      }

      .conversation-last-msg {
        font-size: 14px;
        opacity: 0.7;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .unread-count {
        background: var(--accent);
        color: var(--darker);
        border-radius: 10px;
        font-size: 12px;
        padding: 2px 8px;
        font-weight: bold;
      }

      .chat-container {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
      }

      .chat-header {
        padding: 15px 20px;
        border-bottom: 1px solid var(--glass-border);
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: rgba(0, 0, 0, 0.2);
      }

      .chat-info {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .chat-name {
        font-weight: 600;
      }

      .chat-status {
        font-size: 12px;
        opacity: 0.7;
      }

      .action-icon {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--glass);
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .chat-messages {
        flex-grow: 1;
        padding: 20px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      .message {
        max-width: 70%;
        padding: 12px 18px;
        border-radius: 18px;
        display: inline-block;
        position: relative;
        clear: both;
      }

      .message-outgoing {
        background: var(--message-own);
        color: var(--text-color);
        align-self: flex-end;
        border-bottom-right-radius: 5px;
      }

      .message-incoming {
        background: var(--message-other);
        align-self: flex-start;
        border-bottom-left-radius: 5px;
      }

      .message-time {
        font-size: 11px;
        opacity: 0.7;
        margin-top: 5px;
        text-align: right;
      }

      .message-status {
        float: right;
        margin-left: 5px;
      }

      .chat-input-area {
        padding: 15px 20px;
        border-top: 1px solid var(--glass-border);
        display: flex;
        gap: 10px;
        align-items: center;
        background: var(--card-bg);
      }

      .attachment-btn,
      .emoji-btn {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: var(--glass);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
      }

      .emoji-picker {
        position: absolute;
        bottom: 70px;
        right: 20px;
        background: var(--modal-bg);
        border-radius: 15px;
        padding: 15px;
        backdrop-filter: blur(20px);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        display: none;
        z-index: 1000;
      }

      .emoji-picker.visible {
        display: block;
      }

      .emoji-container {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 10px;
        max-height: 250px;
        overflow-y: auto;
      }

      .emoji-item {
        font-size: 24px;
        cursor: pointer;
        transition: all 0.2s ease;
        text-align: center;
        padding: 5px;
      }

      .emoji-item:hover {
        transform: scale(1.2);
      }

      .ai-assistant {
        position: fixed;
        bottom: 30px;
        right: 30px;
        width: 60px;
        height: 60px;
        background: linear-gradient(45deg, var(--primary), var(--secondary));
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        z-index: 1000;
        transition: all 0.3s ease;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      }

      .ai-assistant:hover {
        transform: scale(1.1);
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.5);
      }

      .ai-chat {
        position: fixed;
        bottom: 100px;
        right: 30px;
        width: 350px;
        height: 400px;
        background: rgba(10, 10, 20, 0.9);
        backdrop-filter: blur(15px);
        border: 1px solid rgba(0, 255, 255, 0.3);
        border-radius: 15px;
        display: none;
        flex-direction: column;
        z-index: 1001;
      }

      .ai-chat-header {
        background: linear-gradient(
          45deg,
          rgba(0, 255, 255, 0.1),
          rgba(255, 0, 255, 0.1)
        );
        padding: 15px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        border-bottom: 1px solid rgba(0, 255, 255, 0.3);
      }

      .ai-chat-header h3 {
        color: var(--primary);
        font-family: "Orbitron", monospace;
      }

      .ai-chat-messages {
        flex: 1;
        padding: 15px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .ai-message {
        max-width: 80%;
        padding: 10px 15px;
        border-radius: 15px;
        font-family: "Exo 2", sans-serif;
      }

      .user-message {
        align-self: flex-end;
        background: rgba(0, 255, 255, 0.2);
        color: var(--light);
      }

      .assistant-message {
        align-self: flex-start;
        background: rgba(255, 255, 255, 0.1);
        color: var(--light);
      }

      .ai-chat-input {
        padding: 15px;
        border-top: 1px solid rgba(0, 255, 255, 0.3);
        display: flex;
        gap: 10px;
      }

      .ai-chat-input input {
        flex: 1;
        padding: 10px 15px;
        border-radius: 20px;
        border: 1px solid rgba(0, 255, 255, 0.3);
        background: rgba(0, 0, 0, 0.5);
        color: var(--light);
      }

      .ai-chat-input button {
        background: linear-gradient(45deg, var(--primary), var(--secondary));
        border: none;
        color: var(--dark);
        padding: 10px 15px;
        border-radius: 20px;
        cursor: pointer;
        font-weight: bold;
      }

      @media (max-width: 768px) {
        .app-layout {
          flex-direction: column;
        }

        .sidebar {
          width: 100%;
          height: auto;
          max-height: 70px;
          padding: 10px;
        }

        .nav-menu {
          flex-direction: row;
          justify-content: space-around;
          overflow-x: auto;
          gap: 0;
        }

        .nav-item span {
          display: none;
        }

        .user-info {
          display: none;
        }

        .main-content {
          padding: 10px;
        }

        .conversations-list {
          width: 100%;
        }
      }

      /* Matrix animated background */
      .matrix-background {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -1;
        background: #000;
        overflow: hidden;
      }

      .matrix-column {
        display: inline-block;
        width: 1em;
        margin: 0 4px;
        position: relative;
        color: rgba(0, 255, 0, 0.5);
        font-size: 18px;
        font-family: monospace;
        text-shadow: 0 0 5px rgba(0, 255, 0, 0.8);
        writing-mode: vertical-rl;
        text-orientation: mixed;
        height: 100%;
        white-space: nowrap;
      }

      /* Toast notifications */
      .toast {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 25px;
        border-radius: 8px;
        color: white;
        font-weight: 600;
        z-index: 10000;
        transform: translateX(150%);
        transition: transform 0.3s ease;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      }

      .toast.show {
        transform: translateX(0);
      }

      .toast.success {
        background: rgba(16, 185, 129, 0.9);
      }

      .toast.error {
        background: rgba(239, 68, 68, 0.9);
      }

      .toast.info {
        background: rgba(59, 130, 246, 0.9);
      }

      /* Media previews */
      .media-preview {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 15px;
      }

      .media-item {
        position: relative;
        width: 100px;
        height: 100px;
        border-radius: 8px;
        overflow: hidden;
      }

      .media-item img,
      .media-item video {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .remove-media {
        position: absolute;
        top: 5px;
        right: 5px;
        background: rgba(0, 0, 0, 0.7);
        border-radius: 50%;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
      }

      /* Theme selector */
      .theme-selector {
        display: flex;
        gap: 15px;
        margin-top: 20px;
      }

      .theme-option {
        width: 60px;
        height: 60px;
        border-radius: 8px;
        cursor: pointer;
        border: 2px solid transparent;
        transition: all 0.3s ease;
      }

      .theme-option.active {
        border-color: var(--accent);
        transform: scale(1.1);
      }

      .theme-dark {
        background: linear-gradient(
          135deg,
          #000000 0%,
          #0a0a0a 25%,
          #1a1a2e 50%,
          #16213e 75%,
          #0f3460 100%
        );
      }

      .theme-light {
        background: linear-gradient(135deg, #f0f2f5, #e2e6ea);
      }

      .theme-cyberpunk {
        background: linear-gradient(135deg, #0a001d, #1d004a);
      }

      /* Image recognition styles */
      .recognition-container {
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      .upload-container {
        display: flex;
        align-items: center;
        justify-content: center;
        border: 2px dashed var(--glass-border);
        border-radius: 15px;
        padding: 40px;
        background: var(--glass);
        cursor: pointer;
        transition: all 0.3s ease;
        flex-direction: column;
        text-align: center;
      }

      .upload-container:hover {
        border-color: var(--primary);
        background: rgba(0, 255, 255, 0.1);
      }

      .upload-container i {
        font-size: 48px;
        margin-bottom: 15px;
        color: var(--primary);
      }

      .recognition-results {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
        margin-top: 30px;
      }

      .recognition-item {
        background: var(--card-bg);
        border-radius: 15px;
        padding: 20px;
        transition: all 0.3s ease;
        border: 1px solid var(--glass-border);
      }

      .recognition-item:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
      }

      .recognition-image {
        width: 100%;
        height: 200px;
        border-radius: 10px;
        object-fit: cover;
        margin-bottom: 15px;
      }

      .recognition-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 10px;
      }

      .recognition-tag {
        background: var(--button-bg);
        color: var(--button-text);
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
      }

      .confidence-bar {
        height: 6px;
        background: var(--glass);
        border-radius: 3px;
        margin-top: 8px;
        overflow: hidden;
      }

      .confidence-level {
        height: 100%;
        background: var(--accent);
        border-radius: 3px;
      }

      .recognition-actions {
        display: flex;
        gap: 10px;
        margin-top: 15px;
      }

      .recognition-details {
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px solid var(--glass-border);
      }

      .recognition-details p {
        margin: 5px 0;
        font-size: 14px;
      }

      .recognition-processing {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 40px;
      }

      .recognition-processing .spinner {
        width: 40px;
        height: 40px;
        margin-bottom: 20px;
      }

      /* New animations */
      @keyframes fadeInApp {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .app-visible {
        animation: fadeInApp 0.5s ease forwards;
      }

      /* Fixed display issues */
      #authContainer {
        display: flex;
      }
    </style>
  </head>
  <body class="dark-theme">
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
      <div class="logo-lg">QUANTUMVAULT</div>
      <div class="spinner"></div>
      <p class="mt-8 text-center">Initializing quantum matrix fields...</p>
    </div>

    <!-- Toast Notification Area -->
    <div id="toastContainer"></div>

    <!-- Authentication Container -->
    <div
      id="authContainer"
      class="fixed inset-0 flex items-center justify-center p-4"
    >
      <div class="glass-morphism p-6" style="width: 100%; max-width: 450px">
        <div class="text-center mb-8">
          <h1
            class="text-3xl font-bold mb-2"
            style="color: #00ffff; font-family: 'Orbitron', monospace"
          >
            <i class="fas fa-atom mr-2"></i>QUANTUMVAULT
          </h1>
          <p class="opacity-70">Access Your Temporal Archives</p>
        </div>

        <!-- Login form -->
        <form id="loginForm" class="space-y-5">
          <div>
            <label class="block text-sm font-medium mb-2">Quantum ID</label>
            <input
              type="email"
              id="loginEmail"
              class="w-full quantum-input"
              placeholder="neural@quantumvault.io"
              required
            />
          </div>
          <div>
            <label class="block text-sm font-medium mb-2">Temporal Key</label>
            <input
              type="password"
              id="loginPassword"
              class="w-full quantum-input"
              placeholder="Enter your key"
              required
            />
          </div>
          <button type="submit" class="w-full quantum-btn py-4 text-lg">
            Access Quantum Network
          </button>
          <div class="text-center mt-4">
            <p class="text-sm opacity-80">
              New to the future?
              <a href="#" class="text-cyan-400 font-medium" id="switchToSignup"
                >Create Neural Profile</a
              >
            </p>
          </div>
        </form>

        <!-- Signup form -->
        <form id="signupForm" class="space-y-5" style="display: none">
          <div>
            <label class="block text-sm font-medium mb-2"
              >Neural Signature</label
            >
            <input
              type="text"
              id="signupUsername"
              class="w-full quantum-input"
              placeholder="Your public identifier"
              required
            />
          </div>
          <div>
            <label class="block text-sm font-medium mb-2">Quantum ID</label>
            <input
              type="email"
              id="signupEmail"
              class="w-full quantum-input"
              placeholder="neural@quantumvault.io"
              required
            />
          </div>
          <div>
            <label class="block text-sm font-medium mb-2">Temporal Key</label>
            <input
              type="password"
              id="signupPassword"
              class="w-full quantum-input"
              placeholder="Create secure key"
              required
            />
          </div>
          <button type="submit" class="w-full quantum-btn py-4 text-lg">
            Initialize Profile
          </button>
          <div class="text-center mt-4">
            <p class="text-sm opacity-80">
              Already have access?
              <a href="#" class="text-cyan-400 font-medium" id="switchToLogin"
                >Entangle Neural Connection</a
              >
            </p>
          </div>
        </form>
      </div>
    </div>

    <!-- Main Application Container -->
    <div class="app-layout" id="mainApp" style="display: none">
      <div class="sidebar">
        <div class="logo-container">
          <div class="logo">QUANTUMVAULT</div>
          <div class="text-sm opacity-70">Temporal Archives System</div>
        </div>

        <div class="nav-menu">
          <div class="nav-item active" data-target="dashboard">
            <i class="fas fa-tachometer-alt"></i>
            <span>Command Center</span>
          </div>
          <div class="nav-item" data-target="create">
            <i class="fas fa-plus-circle"></i>
            <span>Create Capsule</span>
          </div>
          <div class="nav-item" data-target="vault">
            <i class="fas fa-database"></i>
            <span>Quantum Vault</span>
          </div>
          <div class="nav-item" data-target="messages">
            <i class="fas fa-comments"></i>
            <span>Messaging</span>
          </div>
          <div class="nav-item" data-target="recognition">
            <i class="fas fa-camera"></i>
            <span>Image Recognition</span>
          </div>
          <div class="nav-item" data-target="profile">
            <i class="fas fa-user"></i>
            <span>Profile</span>
          </div>
          <div class="nav-item" data-target="settings">
            <i class="fas fa-cogs"></i>
            <span>Configuration</span>
          </div>
        </div>

        <div class="user-profile-summary">
          <div class="user-avatar" id="sidebarAvatar">U</div>
          <div class="user-info">
            <div class="username" id="sidebarUsername">Neural User</div>
            <div class="user-status" id="sidebarStatus">Quantum Level 1</div>
          </div>
          <div>
            <button class="action-icon" id="logoutButton">
              <i class="fas fa-right-from-bracket"></i>
            </button>
          </div>
        </div>
      </div>

      <div class="main-content">
        <!-- Dashboard Section -->
        <div id="dashboard-content" class="content-section active">
          <div class="section-header">
            <h2 class="section-title">Quantum Dashboard</h2>
            <div class="section-description">
              Monitor capsule activities and quantum temporal metrics
            </div>
          </div>

          <div class="glass-morphism p-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
              <div class="quantum-card p-6 text-center">
                <div class="text-4xl mb-2" id="capsuleCount">0</div>
                <h3 class="font-bold">Temporal Capsules</h3>
                <p class="text-sm opacity-80 mt-2">Your preserved memories</p>
              </div>
              <div class="quantum-card p-6 text-center">
                <div class="text-4xl mb-2" id="unlockedCount">0</div>
                <h3 class="font-bold">Unlocked Capsules</h3>
                <p class="text-sm opacity-80 mt-2">Memories you've accessed</p>
              </div>
              <div class="quantum-card p-6 text-center">
                <div class="text-4xl mb-2" id="connectionsCount">0</div>
                <h3 class="font-bold">Quantum Connections</h3>
                <p class="text-sm opacity-80 mt-2">People in your network</p>
              </div>
            </div>

            <div class="mt-8">
              <h3 class="text-xl font-bold mb-4">Recent Activity</h3>
              <div class="space-y-4" id="recentActivity">
                <!-- Activity items will be populated here -->
              </div>
            </div>
          </div>
        </div>

        <!-- Create Capsule Section -->
        <div id="create-content" class="content-section">
          <div class="section-header">
            <h2 class="section-title">Create Time Capsule</h2>
            <div class="section-description">
              Preserve memories for future retrieval
            </div>
          </div>

          <div class="glass-morphism p-6">
            <form id="createCapsuleForm" class="grid sm:grid-cols-2 gap-6">
              <div class="sm:col-span-2">
                <label class="block text-sm font-medium mb-2"
                  >Capsule Name</label
                >
                <input
                  type="text"
                  id="capsuleName"
                  class="quantum-input"
                  placeholder="Future message to myself"
                  required
                />
              </div>

              <div class="sm:col-span-2">
                <label class="block text-sm font-medium mb-2"
                  >Quantum Message</label
                >
                <textarea
                  id="capsuleMessage"
                  class="quantum-input h-32"
                  placeholder="What do you want to preserve?"
                  required
                ></textarea>
              </div>

              <div>
                <label class="block text-sm font-medium mb-2"
                  >Unlock Date</label
                >
                <input
                  type="datetime-local"
                  id="unlockDate"
                  class="quantum-input"
                  min=""
                  required
                />
              </div>

              <div>
                <label class="block text-sm font-medium mb-2"
                  >Temporal Mood</label
                >
                <select id="capsuleMood" class="quantum-input">
                  <option value="">Select mood</option>
                  <option value="joyful">Joyful Celebration</option>
                  <option value="reflective">Reflective Wisdom</option>
                  <option value="hopeful">Hopeful Vision</option>
                  <option value="important">Crucial Information</option>
                </select>
              </div>

              <div>
                <label class="block text-sm font-medium mb-2"
                  >Capsule Type</label
                >
                <select id="capsuleType" class="quantum-input">
                  <option value="personal">Personal Memory</option>
                  <option value="achievement">Milestone Achievement</option>
                  <option value="future-self">Message to Future Self</option>
                  <option value="shared">Shared Experience</option>
                </select>
              </div>

              <div>
                <label class="block text-sm font-medium mb-2"
                  >Recipient (Optional)</label
                >
                <input
                  type="email"
                  id="recipientId"
                  class="quantum-input"
                  placeholder="friend@quantumvault.io"
                />
              </div>

              <div class="sm:col-span-2">
                <label class="block text-sm font-medium mb-2"
                  >Attach Media</label
                >
                <div class="flex items-center gap-3">
                  <input
                    type="file"
                    id="mediaUpload"
                    class="hidden"
                    accept="image/*,video/*"
                    multiple
                  />
                  <button type="button" class="quantum-btn" id="btnAddMedia">
                    <i class="fas fa-plus mr-2"></i>Add Media
                  </button>
                  <span id="fileCount">No files selected</span>
                </div>
                <div class="media-preview mt-3" id="mediaPreview">
                  <!-- Media previews will appear here -->
                </div>
              </div>

              <div class="sm:col-span-2 mt-4">
                <button type="submit" class="quantum-btn w-full py-4">
                  Seal Temporal Capsule
                </button>
              </div>
            </form>
          </div>
        </div>

        <!-- Capsule Vault Section -->
        <div id="vault-content" class="content-section">
          <div class="section-header">
            <h2 class="section-title">Quantum Vault</h2>
            <div class="section-description">Browse your temporal archives</div>
          </div>

          <div
            class="grid md:grid-cols-2 lg:grid-cols-3 gap-6"
            id="capsuleGrid"
          >
            <!-- Capsule cards will be populated here -->
          </div>
        </div>

        <!-- Messaging Section -->
        <div id="messages-content" class="content-section">
          <div class="section-header">
            <h2 class="section-title">Quantum Messaging</h2>
            <div class="section-description">Communicate across timelines</div>
          </div>

          <div class="messages-container">
            <div class="conversations-list">
              <div class="conversations-header">
                <h3 class="font-bold text-lg">Conversations</h3>
              </div>
              <div id="conversationsList">
                <!-- Conversations will be populated here -->
              </div>
            </div>

            <div class="chat-container">
              <div class="chat-header">
                <div class="chat-info">
                  <div class="user-avatar" id="chatAvatar">C</div>
                  <div>
                    <div class="chat-name" id="chatName">
                      Select a conversation
                    </div>
                    <div class="chat-status" id="chatStatus">Offline</div>
                  </div>
                </div>
              </div>

              <div class="chat-messages" id="chatMessages">
                <!-- Messages will appear here -->
              </div>

              <div class="chat-input-area">
                <input
                  type="text"
                  id="messageInput"
                  class="quantum-input"
                  placeholder="Type your message..."
                  disabled
                />
                <button class="quantum-btn" id="btnSendMessage" disabled>
                  <i class="fas fa-paper-plane"></i>
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Image Recognition Section -->
        <div id="recognition-content" class="content-section">
          <div class="section-header">
            <h2 class="section-title">Quantum Image Recognition</h2>
            <div class="section-description">
              Analyze and categorize your visual memories
            </div>
          </div>

          <div class="glass-morphism p-6 recognition-container">
            <div class="upload-container" id="imageUploadContainer">
              <i class="fas fa-cloud-upload-alt"></i>
              <h3 class="text-xl font-bold mb-2">Upload Image for Analysis</h3>
              <p class="opacity-80">
                Drag & drop or click to select an image file
              </p>
              <p class="text-sm opacity-60 mt-2">
                Supported formats: JPG, PNG, GIF
              </p>
              <input
                type="file"
                id="recognitionUpload"
                class="hidden"
                accept="image/*"
              />
            </div>

            <div
              id="recognitionProcessing"
              class="recognition-processing"
              style="display: none"
            >
              <div class="spinner"></div>
              <h3 class="text-xl font-bold">Quantum Analysis in Progress</h3>
              <p class="opacity-80 mt-2">Decrypting visual patterns...</p>
            </div>

            <div class="recognition-results" id="recognitionResults">
              <!-- Results will appear here -->
            </div>
          </div>
        </div>

        <!-- Profile Section -->
        <div id="profile-content" class="content-section">
          <div class="section-header">
            <h2 class="section-title">Quantum Identity</h2>
            <div class="section-description">Manage your temporal profile</div>
          </div>

          <div class="glass-morphism p-6">
            <div class="flex flex-col items-center mb-8">
              <div class="relative">
                <div class="user-avatar w-32 h-32" id="profileAvatar">U</div>
                <button
                  class="absolute bottom-2 right-2 bg-white text-black rounded-full p-2"
                  id="btnChangeAvatar"
                >
                  <i class="fas fa-camera"></i>
                </button>
                <input
                  type="file"
                  id="avatarUpload"
                  class="hidden"
                  accept="image/*"
                />
              </div>
              <h2 class="text-2xl font-bold mt-4" id="profileUsername">
                Username
              </h2>
              <p class="opacity-80" id="profileEmail">user@quantumvault.io</p>
            </div>

            <form id="profileForm" class="space-y-6">
              <div>
                <label class="block text-sm font-medium mb-2"
                  >Neural Signature</label
                >
                <input
                  type="text"
                  id="profileName"
                  class="quantum-input"
                  placeholder="Your display name"
                />
              </div>

              <div>
                <label class="block text-sm font-medium mb-2"
                  >Quantum Bio</label
                >
                <textarea
                  id="profileBio"
                  class="quantum-input h-32"
                  placeholder="Tell others about yourself"
                ></textarea>
              </div>

              <div>
                <button type="submit" class="quantum-btn w-full py-4">
                  Update Quantum Profile
                </button>
              </div>
            </form>
          </div>
        </div>

        <!-- Settings Section -->
        <div id="settings-content" class="content-section">
          <div class="section-header">
            <h2 class="section-title">Quantum Configuration</h2>
            <div class="section-description">Optimize system parameters</div>
          </div>

          <div class="glass-morphism p-6">
            <div>
              <h3 class="text-xl font-bold mb-4">Visual Theme</h3>
              <div class="theme-selector">
                <div
                  class="theme-option theme-dark active"
                  data-theme="dark-theme"
                ></div>
                <div
                  class="theme-option theme-light"
                  data-theme="light-theme"
                ></div>
                <div
                  class="theme-option theme-cyberpunk"
                  data-theme="cyberpunk-theme"
                ></div>
              </div>
            </div>

            <div class="mt-8">
              <h3 class="text-xl font-bold mb-4">Notification Settings</h3>
              <div class="space-y-4">
                <div class="setting-toggle">
                  <span>Capsule Unlock Notifications</span>
                  <label class="switch">
                    <input type="checkbox" id="notifCapsule" checked />
                    <span class="slider"></span>
                  </label>
                </div>
                <div class="setting-toggle">
                  <span>New Message Alerts</span>
                  <label class="switch">
                    <input type="checkbox" id="notifMessages" checked />
                    <span class="slider"></span>
                  </label>
                </div>
                <div class="setting-toggle">
                  <span>System Updates</span>
                  <label class="switch">
                    <input type="checkbox" id="notifSystem" checked />
                    <span class="slider"></span>
                  </label>
                </div>
              </div>
            </div>

            <div class="mt-8">
              <h3 class="text-xl font-bold mb-4">Security Settings</h3>
              <div class="space-y-4">
                <div class="setting-toggle">
                  <span>Two-Factor Authentication</span>
                  <label class="switch">
                    <input type="checkbox" id="security2FA" />
                    <span class="slider"></span>
                  </label>
                </div>
                <div class="setting-toggle">
                  <span>Auto-Lock After Inactivity</span>
                  <label class="switch">
                    <input type="checkbox" id="securityAutoLock" checked />
                    <span class="slider"></span>
                  </label>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Capsule Modal -->
        <div
          id="capsuleModal"
          class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden"
        >
          <div class="glass-morphism w-full max-w-2xl p-8">
            <div class="flex justify-between items-center mb-6">
              <h3 id="modalCapsuleName" class="text-2xl font-bold"></h3>
              <span
                id="modalCapsuleStatus"
                class="text-xs px-3 py-1 rounded-full"
              ></span>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
              <div>
                <p class="opacity-80 mb-2" id="modalUnlockDateText"></p>
                <p class="text-sm opacity-60 mb-6" id="modalCreatedDate"></p>

                <div class="quantum-card p-6">
                  <p class="text-lg" id="modalCapsuleBody"></p>
                </div>

                <div class="mt-4">
                  <span
                    class="py-1 px-3 rounded-full text-sm"
                    id="modalCapsuleMood"
                  ></span>
                </div>

                <div class="mt-6" id="modalMediaGallery">
                  <!-- Media gallery will appear here -->
                </div>
              </div>

              <div>
                <div class="mb-6">
                  <h4 class="font-semibold mb-3">Recipient</h4>
                  <div class="flex items-center gap-3">
                    <div
                      class="user-avatar w-10 h-10"
                      id="modalRecipientAvatar"
                    >
                      R
                    </div>
                    <span id="modalRecipientName" class="font-medium"></span>
                  </div>
                </div>

                <div>
                  <h4 class="font-semibold mb-3">Actions</h4>
                  <div class="flex gap-3">
                    <button class="quantum-btn px-4 py-2">Share</button>
                    <button
                      class="quantum-btn px-4 py-2 bg-transparent border border-cyan-500"
                      id="btnUnlockCapsule"
                    >
                      Unlock
                    </button>
                  </div>
                </div>

                <div class="mt-10">
                  <h4 class="font-semibold mb-3">Quantum Information</h4>
                  <div class="text-sm space-y-2 opacity-80">
                    <p>Capsule ID: <span id="modalCapsuleId"></span></p>
                    <p>Security Level: Quantum-5 Encryption</p>
                    <p>Dimensions: Temporal-Phase Adjusted</p>
                  </div>
                </div>
              </div>
            </div>

            <div class="flex justify-end mt-8">
              <button class="quantum-btn bg-red-500" id="btnCloseModal">
                Close Viewer
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- AI Assistant -->
    <div class="ai-assistant" id="aiAssistant">
      <i class="fas fa-robot"></i>
    </div>

    <!-- AI Chat -->
    <div class="ai-chat" id="aiChat">
      <div class="ai-chat-header">
        <h3>Quantum Assistant</h3>
        <button id="closeAiChat"><i class="fas fa-times"></i></button>
      </div>
      <div class="ai-chat-messages" id="aiMessages">
        <div class="assistant-message">
          Hello! I'm your Quantum Assistant. How can I help you preserve your
          memories?
        </div>
      </div>
      <div class="ai-chat-input">
        <input type="text" id="aiInput" placeholder="Ask anything..." />
        <button id="aiSend"><i class="fas fa-paper-plane"></i></button>
      </div>
    </div>

    <script>
      // ========================
      // CONSTANTS AND STATE
      // ========================

      // Use relative API base so the frontend works behind reverse proxies
      // or when the backend runs on a different host/port.
      const API_BASE = "/api";
      const QUANTUM_LEVELS = [
        "Quantum Novice",
        "Temporal Explorer",
        "Chrono Master",
        "Quantum Guardian",
      ];
      const MOOD_COLORS = {
        joyful: "bg-yellow-500",
        reflective: "bg-blue-500",
        hopeful: "bg-green-500",
        important: "bg-pink-500",
      };
      const MOOD_LABELS = {
        joyful: "Joyful Celebration",
        reflective: "Reflective Wisdom",
        hopeful: "Hopeful Vision",
        important: "Crucial Information",
      };

      let userToken = null;
      let currentUser = null;
      let capsules = [];
      let conversations = [];
      let currentConversation = null;
      let socket = null;
      let selectedMedia = [];
      let recognitionHistory = [];

      // ========================
      // DOM ELEMENTS
      // ========================
      let DOM = {};

      function initializeDOM() {
        DOM = {
          // Authentication elements
          loadingScreen: document.getElementById("loadingScreen"),
          authContainer: document.getElementById("authContainer"),
          loginForm: document.getElementById("loginForm"),
          signupForm: document.getElementById("signupForm"),
          loginEmail: document.getElementById("loginEmail"),
          loginPassword: document.getElementById("loginPassword"),
          signupUsername: document.getElementById("signupUsername"),
          signupEmail: document.getElementById("signupEmail"),
          signupPassword: document.getElementById("signupPassword"),
          switchToLogin: document.getElementById("switchToLogin"),
          switchToSignup: document.getElementById("switchToSignup"),

          // AI Elements
          aiAssistant: document.getElementById("aiAssistant"),
          aiChat: document.getElementById("aiChat"),
          closeAiChat: document.getElementById("closeAiChat"),
          aiMessages: document.getElementById("aiMessages"),
          aiInput: document.getElementById("aiInput"),
          aiSend: document.getElementById("aiSend"),

          // Capsule Elements
          capsuleGrid: document.getElementById("capsuleGrid"),
          createCapsuleForm: document.getElementById("createCapsuleForm"),
          unlockDate: document.getElementById("unlockDate"),
          mediaUpload: document.getElementById("mediaUpload"),
          btnAddMedia: document.getElementById("btnAddMedia"),
          mediaPreview: document.getElementById("mediaPreview"),
          fileCount: document.getElementById("fileCount"),
          capsuleModal: document.getElementById("capsuleModal"),
          btnUnlockCapsule: document.getElementById("btnUnlockCapsule"),
          btnCloseModal: document.getElementById("btnCloseModal"),
          modalMediaGallery: document.getElementById("modalMediaGallery"),

          // Profile Elements
          profileAvatar: document.getElementById("profileAvatar"),
          profileUsername: document.getElementById("profileUsername"),
          profileEmail: document.getElementById("profileEmail"),
          profileForm: document.getElementById("profileForm"),
          profileName: document.getElementById("profileName"),
          profileBio: document.getElementById("profileBio"),
          avatarUpload: document.getElementById("avatarUpload"),
          btnChangeAvatar: document.getElementById("btnChangeAvatar"),
          sidebarAvatar: document.getElementById("sidebarAvatar"),
          sidebarUsername: document.getElementById("sidebarUsername"),

          // Messaging Elements
          conversationsList: document.getElementById("conversationsList"),
          chatMessages: document.getElementById("chatMessages"),
          chatAvatar: document.getElementById("chatAvatar"),
          chatName: document.getElementById("chatName"),
          chatStatus: document.getElementById("chatStatus"),
          messageInput: document.getElementById("messageInput"),
          btnSendMessage: document.getElementById("btnSendMessage"),

          // Dashboard Elements
          capsuleCount: document.getElementById("capsuleCount"),
          unlockedCount: document.getElementById("unlockedCount"),
          connectionsCount: document.getElementById("connectionsCount"),
          recentActivity: document.getElementById("recentActivity"),

          // Settings Elements
          notifCapsule: document.getElementById("notifCapsule"),
          notifMessages: document.getElementById("notifMessages"),
          notifSystem: document.getElementById("notifSystem"),
          security2FA: document.getElementById("security2FA"),
          securityAutoLock: document.getElementById("securityAutoLock"),

          // Image Recognition Elements
          imageUploadContainer: document.getElementById("imageUploadContainer"),
          recognitionUpload: document.getElementById("recognitionUpload"),
          recognitionProcessing: document.getElementById(
            "recognitionProcessing"
          ),
          recognitionResults: document.getElementById("recognitionResults"),
          mainApp: document.getElementById("mainApp"),
          toastContainer: document.getElementById("toastContainer"),
        };
      }

      // ========================
      // SETUP AND EVENT HANDLERS
      // ========================
      function setupEventListeners() {
        // Set minimum date to tomorrow for time capsules
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        if (DOM.unlockDate) {
          DOM.unlockDate.min = tomorrow.toISOString().slice(0, 16);
        }

        // Hide the main app initially
        if (DOM.mainApp) {
          DOM.mainApp.style.display = "none";
        }

        // Setup authentication switch
        if (DOM.switchToSignup) {
          DOM.switchToSignup.addEventListener("click", showSignupForm);
        }
        if (DOM.switchToLogin) {
          DOM.switchToLogin.addEventListener("click", showLoginForm);
        }

        // Setup AI handlers
        if (DOM.aiAssistant) {
          DOM.aiAssistant.addEventListener("click", openAIChat);
        }
        if (DOM.closeAiChat) {
          DOM.closeAiChat.addEventListener("click", closeAIChat);
        }
        if (DOM.aiSend) {
          DOM.aiSend.addEventListener("click", sendAIMessage);
        }
        if (DOM.aiInput) {
          DOM.aiInput.addEventListener("keypress", (e) => {
            if (e.key === "Enter") sendAIMessage();
          });
        }

        // Setup capsule handlers
        if (DOM.createCapsuleForm) {
          DOM.createCapsuleForm.addEventListener("submit", createCapsule);
        }
        if (DOM.btnAddMedia) {
          DOM.btnAddMedia.addEventListener("click", () =>
            DOM.mediaUpload.click()
          );
        }
        if (DOM.mediaUpload) {
          DOM.mediaUpload.addEventListener("change", handleMediaUpload);
        }
        if (DOM.btnCloseModal) {
          DOM.btnCloseModal.addEventListener("click", () => {
            DOM.capsuleModal.classList.add("hidden");
          });
        }
        if (DOM.btnUnlockCapsule) {
          DOM.btnUnlockCapsule.addEventListener("click", unlockCapsule);
        }

        // Setup profile handlers
        if (DOM.btnChangeAvatar) {
          DOM.btnChangeAvatar.addEventListener("click", () =>
            DOM.avatarUpload.click()
          );
        }
        if (DOM.avatarUpload) {
          DOM.avatarUpload.addEventListener("change", uploadAvatar);
        }
        if (DOM.profileForm) {
          DOM.profileForm.addEventListener("submit", updateProfile);
        }

        // Setup messaging handlers
        if (DOM.btnSendMessage) {
          DOM.btnSendMessage.addEventListener("click", sendMessage);
        }
        if (DOM.messageInput) {
          DOM.messageInput.addEventListener("keypress", (e) => {
            if (e.key === "Enter") sendMessage();
          });
        }

        // Setup theme switcher
        document.querySelectorAll(".theme-option").forEach((option) => {
          option.addEventListener("click", () => {
            document
              .querySelectorAll(".theme-option")
              .forEach((opt) => opt.classList.remove("active"));
            option.classList.add("active");
            document.body.className = option.dataset.theme;
            localStorage.setItem("theme", option.dataset.theme);
          });
        });

        // Setup navigation
        document.querySelectorAll(".nav-item").forEach((item) => {
          item.addEventListener("click", function () {
            document
              .querySelectorAll(".nav-item")
              .forEach((i) => i.classList.remove("active"));
            this.classList.add("active");

            const sectionName = this.dataset.target;
            document.querySelectorAll(".content-section").forEach((section) => {
              section.classList.remove("active");
            });
            document
              .getElementById(`${sectionName}-content`)
              .classList.add("active");
          });
        });

        // Setup logout
        const logoutButton = document.getElementById("logoutButton");
        if (logoutButton) {
          logoutButton.addEventListener("click", () => {
            localStorage.removeItem("quantumToken");
            window.location.reload();
          });
        }

        // Setup image recognition handlers
        if (DOM.imageUploadContainer) {
          DOM.imageUploadContainer.addEventListener("click", () =>
            DOM.recognitionUpload.click()
          );
        }
        if (DOM.recognitionUpload) {
          DOM.recognitionUpload.addEventListener(
            "change",
            handleImageRecognition
          );
        }

        // Setup form submissions
        if (DOM.loginForm) {
          DOM.loginForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            await loginUser();
          });
        }

        if (DOM.signupForm) {
          DOM.signupForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            await registerUser();
          });
        }
      }

      // ========================
      // AUTHENTICATION
      // ========================
      function showLoginForm(e) {
        if (e) e.preventDefault();
        if (DOM.loginForm) DOM.loginForm.style.display = "block";
        if (DOM.signupForm) DOM.signupForm.style.display = "none";
      }

      function showSignupForm(e) {
        if (e) e.preventDefault();
        if (DOM.loginForm) DOM.loginForm.style.display = "none";
        if (DOM.signupForm) DOM.signupForm.style.display = "block";
      }

      async function checkExistingSession(retries = 3) {
        const token = localStorage.getItem("quantumToken");
        console.log("Stored token:", token);

        if (!token) {
          if (DOM.loadingScreen) DOM.loadingScreen.style.display = "none";
          if (DOM.authContainer) showAuthContainer();
          return;
        }

        try {
          const response = await fetch(`${API_BASE}/users/profile`, {
            headers: {
              Authorization: `Bearer ${token}`,
            },
          });

          if (!response.ok) throw new Error("Invalid session");

          const data = await response.json();
          userToken = token;
          currentUser = data.user;

          initApp();
        } catch (err) {
          if (retries > 0) {
            console.warn("Retrying session check...");
            return setTimeout(() => checkExistingSession(retries - 1), 1000);
          }

          console.error("Session check failed:", err.message);
          localStorage.removeItem("quantumToken");
          if (DOM.loadingScreen) DOM.loadingScreen.style.display = "none";
          if (DOM.authContainer) showAuthContainer();
        }
      }

      function hideLoadingScreen() {
        if (DOM.loadingScreen) {
          DOM.loadingScreen.style.opacity = "0";
          setTimeout(() => {
            if (DOM.loadingScreen) {
              DOM.loadingScreen.style.display = "none";
            }
          }, 500);
        }
      }

      function showAuthContainer() {
        if (DOM.authContainer) {
          DOM.authContainer.style.display = "flex";
          DOM.authContainer.classList.add("app-visible");
        }
      }

      async function loginUser() {
  const email = DOM.loginEmail ? DOM.loginEmail.value : "";
  const password = DOM.loginPassword ? DOM.loginPassword.value : "";

  if (!email || !password) {
    showToast("Email and password are required", "error");
    return;
  }

  try {
    const formData = new URLSearchParams();
    formData.append("username", email); // FastAPI expects "username"
    formData.append("password", password);

    const response = await fetch(`${API_BASE}/auth/token`, {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: formData,
    });

    const data = await response.json();
    if (!response.ok) throw new Error(data.detail || "Login failed");

    localStorage.setItem("quantumToken", data.access_token);
    userToken = data.access_token;
    // You may need to fetch user profile here
    hideLoadingScreen();
    initApp();
  } catch (error) {
    showToast(
      error.message || "Login failed. Check your credentials.",
      "error"
    );
  }
}

     async function registerUser () {
  const username = DOM.signupUsername?.value || "";
  const email = DOM.signupEmail?.value || "";
  const password = DOM.signupPassword?.value || "";

  if (!username || !email || !password) {
    showToast("All fields are required", "error");
    return;
  }

  try {
    const response = await fetch(`${API_BASE}/auth/register`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ username, email, password }),
    });

    const data = await response.json(); // may throw if not valid JSON

   if (!response.ok) {
  console.error("Signup failed:", data); // Log the error response
  showToast(data.detail ? JSON.stringify(data.detail) : "Signup failed", "error");
  throw new Error(data.detail ? JSON.stringify(data.detail) : "Signup failed");
}

    localStorage.setItem("quantumToken", data.token);
    userToken = data.token;
    currentUser  = data.user;
    hideLoadingScreen();
    initApp();

  } catch (error) {
    console.error("Signup error:", error.message);
    showToast(error.message || "Signup failed. Please try again.", "error");
  }
}


      // ========================
      // APP INITIALIZATION
      // ========================
      function initApp() {
        // Hide auth container and show app
        if (DOM.authContainer) DOM.authContainer.style.display = "none";
        if (DOM.mainApp) DOM.mainApp.style.display = "flex";

        setTimeout(() => {
          if (DOM.mainApp) DOM.mainApp.classList.add("app-visible");

          // Load user data
          loadUserProfile();

          // Load capsules from server
          loadCapsules();

          // Load conversations
          loadConversations();

          // Initialize socket for real-time updates
          initQuantumSocket();
        }, 50);
      }

      function loadUserProfile() {
        if (!currentUser) return;

        if (DOM.profileUsername)
          DOM.profileUsername.textContent = currentUser.username;
        if (DOM.profileEmail) DOM.profileEmail.textContent = currentUser.email;
        if (DOM.profileName) DOM.profileName.value = currentUser.username;
        if (DOM.profileBio) DOM.profileBio.value = currentUser.bio || "";

        if (DOM.sidebarUsername)
          DOM.sidebarUsername.textContent = currentUser.username;
        if (DOM.sidebarStatus)
          DOM.sidebarStatus.textContent =
            QUANTUM_LEVELS[currentUser.quantum_level || 0];

        updateAvatar(currentUser.avatar);
      }

      function updateAvatar(avatarUrl) {
        if (!avatarUrl) return;

        if (DOM.profileAvatar) {
          DOM.profileAvatar.style.backgroundImage = `url(${avatarUrl})`;
          DOM.profileAvatar.textContent = "";
        }

        if (DOM.sidebarAvatar) {
          DOM.sidebarAvatar.style.backgroundImage = `url(${avatarUrl})`;
          DOM.sidebarAvatar.textContent = "";
        }
      }

      async function loadCapsules() {
        try {
          const response = await fetch(`${API_BASE}/capsules`, {
            headers: { Authorization: `Bearer ${userToken}` },
          });

          if (!response.ok) throw new Error("Failed to load capsules");

          capsules = await response.json();
          renderCapsules();
          updateDashboard();
        } catch (error) {
          showToast("Failed to load temporal capsules", "error");
        }
      }

      async function loadConversations() {
        try {
          const response = await fetch(`${API_BASE}/chat/conversations`, {
  headers: { Authorization: `Bearer ${userToken}` },
});

          if (!response.ok) throw new Error("Failed to load conversations");

          conversations = await response.json();
          renderConversations();
        } catch (error) {
          showToast("Failed to load conversations", "error");
        }
      }

      // ========================
      // IMAGE RECOGNITION
      // ========================
      function handleImageRecognition(e) {
        if (!DOM.imageUploadContainer || !DOM.recognitionProcessing) return;

        const file = e.target.files[0];
        if (!file) return;

        // Show processing indicator
        DOM.recognitionProcessing.style.display = "flex";
        DOM.imageUploadContainer.style.display = "none";

        // Create preview
        const reader = new FileReader();
        reader.onload = function (e) {
          // Simulate AI processing (in a real app, this would be an API call)
          setTimeout(() => {
            processImageRecognition(file, e.target.result);
          }, 1500);
        };
        reader.readAsDataURL(file);
      }

      function processImageRecognition(file, imageData) {
        if (
          !DOM.recognitionProcessing ||
          !DOM.recognitionResults ||
          !DOM.imageUploadContainer
        )
          return;

        // This is a simulation - in a real app, you would call an AI service API
        const recognitionId = "rec_" + Date.now();
        const tags = generateRandomTags();
        const objects = generateRandomObjects();

        const recognitionResult = {
          id: recognitionId,
          image: imageData,
          fileName: file.name,
          date: new Date().toISOString(),
          tags: tags,
          objects: objects,
          description: generateDescription(tags, objects),
        };

        // Add to history
        recognitionHistory.unshift(recognitionResult);

        // Render results
        renderRecognitionResults();

        // Show results and hide processing
        DOM.recognitionProcessing.style.display = "none";
        DOM.imageUploadContainer.style.display = "flex";

        showToast("Image analysis complete!", "success");
      }

      function generateRandomTags() {
        const allTags = [
          "Nature",
          "Urban",
          "Technology",
          "People",
          "Landscape",
          "Animals",
          "Architecture",
          "Ocean",
          "Mountains",
          "Forest",
          "Sunset",
          "Sky",
          "Abstract",
          "Pattern",
          "Texture",
          "Minimal",
          "Vintage",
          "Modern",
        ];

        const numTags = Math.floor(Math.random() * 4) + 3;
        const tags = [];

        for (let i = 0; i < numTags; i++) {
          const randomIndex = Math.floor(Math.random() * allTags.length);
          const tag = allTags[randomIndex];
          if (!tags.includes(tag)) {
            tags.push(tag);
          }
        }

        return tags;
      }

      function generateRandomObjects() {
        const allObjects = [
          {
            name: "Person",
            confidence: (Math.random() * 0.5 + 0.5).toFixed(2),
          },
          {
            name: "Building",
            confidence: (Math.random() * 0.5 + 0.5).toFixed(2),
          },
          { name: "Tree", confidence: (Math.random() * 0.5 + 0.5).toFixed(2) },
          { name: "Car", confidence: (Math.random() * 0.5 + 0.5).toFixed(2) },
          { name: "Sky", confidence: (Math.random() * 0.5 + 0.5).toFixed(2) },
          { name: "Water", confidence: (Math.random() * 0.5 + 0.5).toFixed(2) },
          {
            name: "Mountain",
            confidence: (Math.random() * 0.5 + 0.5).toFixed(2),
          },
          {
            name: "Animal",
            confidence: (Math.random() * 0.5 + 0.5).toFixed(2),
          },
        ];

        const numObjects = Math.floor(Math.random() * 4) + 2;
        const objects = [];

        for (let i = 0; i < numObjects; i++) {
          const randomIndex = Math.floor(Math.random() * allObjects.length);
          objects.push(allObjects[randomIndex]);
        }

        return objects;
      }

      function generateDescription(tags, objects) {
        const locations = [
          "urban cityscape",
          "natural landscape",
          "coastal area",
          "mountainous region",
          "forest environment",
        ];
        const times = [
          "during sunset",
          "at dawn",
          "in daylight",
          "at night",
          "during golden hour",
        ];
        const actions = [
          "people interacting",
          "a solitary figure",
          "wildlife in motion",
          "vehicles moving",
          "still life",
        ];

        const location =
          locations[Math.floor(Math.random() * locations.length)];
        const time = times[Math.floor(Math.random() * times.length)];
        const action = actions[Math.floor(Math.random() * actions.length)];

        const primaryObjects = objects
          .slice(0, 2)
          .map((obj) => obj.name.toLowerCase())
          .join(" and ");

        return `This image depicts a ${location} ${time}, featuring ${primaryObjects} with ${action}.`;
      }

      function renderRecognitionResults() {
        if (!DOM.recognitionResults) return;

        DOM.recognitionResults.innerHTML = "";

        if (recognitionHistory.length === 0) {
          DOM.recognitionResults.innerHTML = `
      <div class="col-span-3 text-center py-12">
        <i class="fas fa-images text-4xl mb-4 opacity-60"></i>
        <h3 class="text-xl font-bold">No Recognition History</h3>
        <p class="opacity-80">Upload an image to begin analysis</p>
      </div>
    `;
          return;
        }

        recognitionHistory.forEach((result) => {
          const recognitionItem = document.createElement("div");
          recognitionItem.className = "recognition-item";
          recognitionItem.innerHTML = `
      <h3 class="font-bold text-lg mb-2">${result.fileName}</h3>
      <p class="text-sm opacity-80">${new Date(
        result.date
      ).toLocaleString()}</p>
      <img src="${result.image}" alt="Analyzed image" class="recognition-image">
      <div>
        <h4 class="font-medium">Description:</h4>
        <p>${result.description}</p>
      </div>
      <div class="recognition-tags">
        ${result.tags
          .map((tag) => `<span class="recognition-tag">${tag}</span>`)
          .join("")}
      </div>
      <div class="recognition-details">
        <h4 class="font-medium mt-4">Object Recognition:</h4>
        ${result.objects
          .map(
            (obj) => `
            <div class="mt-2">
              <div class="flex justify-between">
                <span>${obj.name}</span>
                <span>${Math.floor(obj.confidence * 100)}%</span>
              </div>
              <div class="confidence-bar">
                <div class="confidence-level" style="width: ${
                  obj.confidence * 100
                }%"></div>
              </div>
            </div>
          `
          )
          .join("")}
      </div>
      <div class="recognition-actions">
        <button class="quantum-btn flex-1">Save to Vault</button>
        <button class="quantum-btn flex-1 bg-transparent border border-cyan-500">Share</button>
      </div>
    `;

          DOM.recognitionResults.appendChild(recognitionItem);
        });
      }

      // ========================
      // CAPSULE MANAGEMENT
      // ========================
      function handleMediaUpload(e) {
        if (!DOM.mediaPreview || !DOM.fileCount) return;

        const files = Array.from(e.target.files);
        selectedMedia = [...selectedMedia, ...files];

        // Update file count
        DOM.fileCount.textContent = `${selectedMedia.length} file${
          selectedMedia.length !== 1 ? "s" : ""
        } selected`;

        // Clear preview
        DOM.mediaPreview.innerHTML = "";

        // Add previews
        selectedMedia.forEach((file, index) => {
          const reader = new FileReader();
          reader.onload = function (e) {
            const mediaItem = document.createElement("div");
            mediaItem.className = "media-item";

            if (file.type.startsWith("image")) {
              mediaItem.innerHTML = `
          <img src="${e.target.result}" alt="Preview">
          <div class="remove-media" data-index="${index}">
            <i class="fas fa-times"></i>
          </div>
        `;
            } else if (file.type.startsWith("video")) {
              mediaItem.innerHTML = `
          <video src="${e.target.result}" controls></video>
          <div class="remove-media" data-index="${index}">
            <i class="fas fa-times"></i>
          </div>
        `;
            }

            DOM.mediaPreview.appendChild(mediaItem);

            // Add remove event
            mediaItem
              .querySelector(".remove-media")
              ?.addEventListener("click", (e) => {
                const index = parseInt(e.currentTarget.dataset.index);
                selectedMedia.splice(index, 1);
                handleMediaUpload({ target: { files: [] } }); // Refresh preview
              });
          };
          reader.readAsDataURL(file);
        });
      }

      async function createCapsule(e) {
        e.preventDefault();

        if (
          !DOM.capsuleName ||
          !DOM.capsuleMessage ||
          !DOM.unlockDate ||
          !DOM.capsuleMood ||
          !DOM.capsuleType
        ) {
          showToast("Please fill in all required fields", "error");
          return;
        }

        const formData = new FormData();
        formData.append("name", DOM.capsuleName.value);
        formData.append("content", DOM.capsuleMessage.value);
        formData.append("unlock_date", DOM.unlockDate.value);
        formData.append("mood", DOM.capsuleMood.value);
        formData.append("type", DOM.capsuleType.value);
        if (DOM.recipientId && DOM.recipientId.value) {
          formData.append("recipient_id", DOM.recipientId.value);
        }

        // Add media files
        selectedMedia.forEach((file) => {
          formData.append("media", file);
        });

        try {
          const response = await fetch(`${API_BASE}/capsules`, {
            method: "POST",
            headers: {
              Authorization: `Bearer ${userToken}`,
            },
            body: formData,
          });

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || "Failed to create capsule");
          }

          const data = await response.json();
          capsules.push(data.capsule);
          renderCapsules();
          updateDashboard();

          showToast("Capsule sealed successfully!", "success");
          if (DOM.createCapsuleForm) DOM.createCapsuleForm.reset();
          selectedMedia = [];
          if (DOM.mediaPreview) DOM.mediaPreview.innerHTML = "";
          if (DOM.fileCount) DOM.fileCount.textContent = "No files selected";
        } catch (error) {
          showToast(error.message || "Failed to create capsule", "error");
        }
      }

      async function unlockCapsule() {
        if (!DOM.capsuleModal || !userToken) return;

        const capsuleId = DOM.capsuleModal.dataset.capsuleId;
        if (!capsuleId) return;

        try {
          const response = await fetch(
            `${API_BASE}/capsules/${capsuleId}/unlock`,
            {
              method: "PUT",
              headers: { Authorization: `Bearer ${userToken}` },
            }
          );

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || "Failed to unlock capsule");
          }

          showToast(
            "Capsule activated! Accessing temporal content...",
            "success"
          );

          // Update capsule status in UI
          const capsule = capsules.find((c) => c._id === capsuleId);
          if (capsule) {
            capsule.status = "unlocked";
            const statusElement = document.getElementById("modalCapsuleStatus");
            if (statusElement) {
              statusElement.textContent = "UNLOCKED";
              statusElement.style.background = "#00ff00";
            }

            // Show capsule content after short delay
            setTimeout(() => {
              const contentElement =
                document.getElementById("modalCapsuleBody");
              if (contentElement) {
                contentElement.textContent = capsule.content;
              }
              renderMediaGallery(capsule.media);
            }, 1000);
          }
        } catch (error) {
          showToast(error.message || "Failed to unlock capsule", "error");
        }
      }

      function openCapsule(capsuleId) {
        const capsule = capsules.find((c) => c._id === capsuleId);
        if (!capsule || !DOM.capsuleModal) return;

        // Update modal with capsule data
        const modalCapsuleName = document.getElementById("modalCapsuleName");
        const modalCapsuleStatus =
          document.getElementById("modalCapsuleStatus");
        const modalUnlockDateText = document.getElementById(
          "modalUnlockDateText"
        );
        const modalCreatedDate = document.getElementById("modalCreatedDate");
        const modalCapsuleBody = document.getElementById("modalCapsuleBody");
        const modalRecipientName =
          document.getElementById("modalRecipientName");

        if (modalCapsuleName) modalCapsuleName.textContent = capsule.name;
        if (modalCapsuleStatus) {
          modalCapsuleStatus.textContent = capsule.status.toUpperCase();
          modalCapsuleStatus.style.background =
            capsule.status === "unlocked" ? "#00ff00" : "#ff00ff";
        }
        if (modalUnlockDateText) {
          modalUnlockDateText.textContent = `Unlocks: ${new Date(
            capsule.unlock_date
          ).toLocaleDateString()}`;
        }
        if (modalCreatedDate) {
          modalCreatedDate.textContent = `Created: ${new Date(
            capsule.created_at
          ).toLocaleDateString()}`;
        }

        const modalCapsuleMood = document.getElementById("modalCapsuleMood");
        if (modalCapsuleMood) {
          modalCapsuleMood.textContent = `${
            MOOD_LABELS[capsule.mood]
          } ${getMoodEmoji(capsule.mood)}`;
        }

        if (modalCapsuleBody) {
          modalCapsuleBody.textContent =
            capsule.status === "unlocked"
              ? capsule.content
              : "This capsule is sealed. Unlock to view contents.";
        }

        if (modalRecipientName) {
          modalRecipientName.textContent = capsule.recipient_id || "Only you";
        }

        // Render media gallery
        renderMediaGallery(capsule.media);

        // Store ID for unlocking
        DOM.capsuleModal.dataset.capsuleId = capsule._id;

        // Show the modal
        DOM.capsuleModal.classList.remove("hidden");
      }

      function renderMediaGallery(media) {
        if (!DOM.modalMediaGallery) return;

        DOM.modalMediaGallery.innerHTML = "";

        if (!media || media.length === 0) return;

        DOM.modalMediaGallery.innerHTML =
          '<h4 class="font-semibold mb-3">Media Gallery</h4><div class="flex flex-wrap gap-3">';

        media.forEach((item) => {
          if (item.type.startsWith("image")) {
            DOM.modalMediaGallery.innerHTML += `
        <div class="w-24 h-24 rounded-lg overflow-hidden">
          <img src="${item.url}" alt="Capsule media" class="w-full h-full object-cover">
        </div>
      `;
          } else if (item.type.startsWith("video")) {
            DOM.modalMediaGallery.innerHTML += `
        <div class="w-24 h-24 rounded-lg overflow-hidden relative">
          <video src="${item.url}" class="w-full h-full object-cover" controls></video>
        </div>
      `;
          }
        });

        DOM.modalMediaGallery.innerHTML += "</div>";
      }

      function getMoodEmoji(mood) {
        const emojis = {
          joyful: "",
          reflective: "",
          hopeful: "",
          important: "",
        };
        return emojis[mood] || "";
      }

      function renderCapsules() {
        if (!DOM.capsuleGrid) return;

        DOM.capsuleGrid.innerHTML = "";

        if (!capsules.length) {
          DOM.capsuleGrid.innerHTML = `
      <div class="glass-morphism p-8 text-center col-span-3">
        <div class="text-5xl mb-4"></div>
        <h3 class="text-xl font-bold mb-2">Empty Quantum Vault</h3>
        <p class="opacity-80">Your temporal archives are empty. Create your first capsule to fill this void.</p>
      </div>
    `;
          return;
        }

        capsules.forEach((capsule) => {
          const moodColor = MOOD_COLORS[capsule.mood] || "bg-gray-600";
          const isUnlocked = capsule.status === "unlocked";

          const card = document.createElement("div");
          card.className = "quantum-card p-6 cursor-pointer";
          card.addEventListener("click", () => openCapsule(capsule._id));

          card.innerHTML = `
      <div class="flex items-center justify-between mb-4">
        <h3 class="font-bold text-lg">${capsule.name}</h3>
        <span class="text-xs px-2 py-1 rounded-full ${moodColor}">${
            capsule.mood
          }</span>
      </div>

      <p class="text-sm opacity-80 mb-2">Created: ${new Date(
        capsule.created_at
      ).toLocaleDateString()}</p>
      <p class="text-sm font-medium mb-4">Unlocks: ${new Date(
        capsule.unlock_date
      ).toLocaleDateString()}</p>

      <div class="flex items-center justify-between">
        <span class="status-indicator flex items-center ${
          isUnlocked ? "text-green-400" : "text-yellow-400"
        }">
          ${isUnlocked ? "OPEN" : "SEALED"}
        </span>
        <span class="text-xs opacity-70">View Capsule </span>
      </div>
    `;

          DOM.capsuleGrid.appendChild(card);
        });
      }

      // ========================
      // PROFILE MANAGEMENT
      // ========================
      async function uploadAvatar(e) {
        const file = e.target.files[0];
        if (!file) return;

        const formData = new FormData();
        formData.append("file", file);

        try {
          const response = await fetch(`${API_BASE}/users/upload-avatar`, {
            method: "POST",
            headers: {
              Authorization: `Bearer ${userToken}`,
            },
            body: formData,
          });

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || "Failed to upload avatar");
          }

          const data = await response.json();
          currentUser.avatar = data.avatarUrl;
          updateAvatar(data.avatarUrl);
          showToast("Avatar updated successfully!", "success");
        } catch (error) {
          showToast(error.message || "Failed to upload avatar", "error");
        }
      }

      async function updateProfile(e) {
        e.preventDefault();

        const username = DOM.profileName ? DOM.profileName.value : "";
        const bio = DOM.profileBio ? DOM.profileBio.value : "";

        try {
          const response = await fetch(`${API_BASE}/users/profile`, {
            method: "PUT",
            headers: {
              Authorization: `Bearer ${userToken}`,
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ username, bio }),
          });

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || "Failed to update profile");
          }

          const data = await response.json();
          currentUser.username = data.username;
          currentUser.bio = data.bio;

          if (DOM.sidebarUsername)
            DOM.sidebarUsername.textContent = data.username;
          if (DOM.profileUsername)
            DOM.profileUsername.textContent = data.username;

          // Update avatar section username indicators
          if (DOM.profileAvatar)
            DOM.profileAvatar.textContent = data.username
              .charAt(0)
              .toUpperCase();
          if (DOM.sidebarAvatar)
            DOM.sidebarAvatar.textContent = data.username
              .charAt(0)
              .toUpperCase();

          showToast("Profile updated successfully!", "success");
        } catch (error) {
          showToast(error.message || "Failed to update profile", "error");
        }
      }

      // ========================
      // DASHBOARD FUNCTIONS
      // ========================
      function updateDashboard() {
        const unlocked = capsules.filter((c) => c.status === "unlocked").length;
        const capsuleCount = capsules.length;

        if (DOM.capsuleCount) DOM.capsuleCount.textContent = capsuleCount;
        if (DOM.unlockedCount) DOM.unlockedCount.textContent = unlocked;
        if (DOM.connectionsCount)
          DOM.connectionsCount.textContent = currentUser.friends?.length || 0;

        // Update recent activity
        if (!DOM.recentActivity) return;

        DOM.recentActivity.innerHTML = "";

        if (capsuleCount === 0) {
          DOM.recentActivity.innerHTML = `
      <div class="text-center py-8 text-sm opacity-80">
        No recent activity. Create your first capsule to start preserving memories!
      </div>
    `;
          return;
        }

        // Show latest 5 capsules as recent activity
        const recentCapsules = [...capsules]
          .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
          .slice(0, 5);

        recentCapsules.forEach((capsule) => {
          const activityItem = document.createElement("div");
          activityItem.className =
            "flex items-center border-b border-opacity-20 pb-4";

          activityItem.innerHTML = `
      <div class="w-10 h-10 rounded-full mr-4 flex-shrink-0 bg-${
        MOOD_COLORS[capsule.mood]
      } flex items-center justify-center">
        ${capsule.mood.charAt(0).toUpperCase()}
      </div>
      <div>
        <h4 class="font-medium">Created capsule: ${capsule.name}</h4>
        <p class="text-sm opacity-80">${formatDate(
          capsule.created_at
        )}  Status:
          <span class="${
            capsule.status === "unlocked" ? "text-green-400" : "text-yellow-400"
          }">
            ${capsule.status}
          </span>
        </p>
      </div>
    `;

          DOM.recentActivity.appendChild(activityItem);
        });
      }

      // ========================
      // MESSAGING SYSTEM
      // ========================
      function renderConversations() {
        if (!DOM.conversationsList) return;

        DOM.conversationsList.innerHTML = "";

        conversations.forEach((conversation) => {
          const conversationItem = document.createElement("div");
          conversationItem.className = `conversation-item ${
            conversation.unread > 0 ? "unread" : ""
          }`;
          conversationItem.innerHTML = `
      <div class="flex items-center">
        <div class="w-12 h-12 rounded-full bg-${
          MOOD_COLORS[Math.floor(Math.random() * 4)]
        } mr-3 flex items-center justify-center">
          ${conversation.name.charAt(0)}
        </div>
        <div class="flex-1">
          <h4 class="font-bold">${conversation.name}</h4>
          <p class="text-sm opacity-80 truncate max-w-xs">${
            conversation.lastMessage || "Start a conversation"
          }</p>
        </div>
        <div class="text-xs opacity-60 ml-2">
          ${formatTime(conversation.lastMessageTime) || ""}
        </div>
        ${
          conversation.unread > 0
            ? `<div class="w-5 h-5 rounded-full bg-red-500 text-white text-xs flex items-center justify-center ml-2">${conversation.unread}</div>`
            : ""
        }
      </div>
    `;

          conversationItem.addEventListener("click", () =>
            selectConversation(conversation)
          );
          DOM.conversationsList.appendChild(conversationItem);
        });
      }

      function selectConversation(conversation) {
        currentConversation = conversation;
        renderConversation();
      }

      function renderConversation() {
        if (
          !currentConversation ||
          !DOM.chatName ||
          !DOM.chatStatus ||
          !DOM.chatMessages
        )
          return;

        DOM.chatName.textContent = currentConversation.name;
        DOM.chatStatus.textContent = currentConversation.online
          ? "Online"
          : "Offline";
        DOM.chatMessages.innerHTML = "";
        if (DOM.messageInput) DOM.messageInput.disabled = false;
        if (DOM.btnSendMessage) DOM.btnSendMessage.disabled = false;

        // Display conversation messages
        currentConversation.messages.forEach((msg) => {
          addMessageToChat(msg);
        });

        // Mark as read
        if (currentConversation.unread > 0) {
          markConversationAsRead(currentConversation);
        }
      }

      function addMessageToChat(message) {
        if (!DOM.chatMessages) return;

        const isCurrentUser = currentUser.username === message.sender;
        const messageDiv = document.createElement("div");
        messageDiv.className = `flex my-2 ${
          isCurrentUser ? "justify-end" : "justify-start"
        }`;

        messageDiv.innerHTML = `
    <div class="max-w-[75%]">
      <div class="text-xs opacity-70 mb-1 ${isCurrentUser ? "text-right" : ""}">
        ${isCurrentUser ? "You" : message.sender}
      </div>
      <div class="p-3 rounded-2xl ${
        isCurrentUser
          ? "bg-blue-500 rounded-br-none"
          : "bg-gray-700 rounded-bl-none"
      }">
        ${message.text}
      </div>
      <div class="text-xs opacity-60 mt-1 ${isCurrentUser ? "text-right" : ""}">
        ${formatTime(message.time)}
      </div>
    </div>
  `;

        DOM.chatMessages.appendChild(messageDiv);
        DOM.chatMessages.scrollTop = DOM.chatMessages.scrollHeight;
      }

      async function markConversationAsRead(conversation) {
        try {
          const response = await fetch(
            `${API_BASE}/conversations/${conversation.id}/read`,
            {
              method: "PUT",
              headers: { Authorization: `Bearer ${userToken}` },
            }
          );

          if (!response.ok) throw new Error("Failed to mark as read");

          conversation.unread = 0;
          renderConversations();
        } catch (error) {
          console.error(error);
        }
      }

      async function sendMessage() {
        if (!currentConversation || !DOM.messageInput) return;

        const text = DOM.messageInput.value.trim();
        if (!text) return;

        const message = {
          text,
          sender: currentUser.username,
          time: new Date().toISOString(),
        };

        // Add to UI immediately
        addMessageToChat({ ...message, status: "sending" });
        DOM.messageInput.value = "";

        try {
          const response = await fetch(`${API_BASE}/messages`, {
            method: "POST",
            headers: {
              Authorization: `Bearer ${userToken}`,
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              conversationId: currentConversation.id,
              text,
            }),
          });

          if (!response.ok) {
            throw new Error("Failed to send message");
          }

          // Update message status to sent
          const messages = DOM.chatMessages.querySelectorAll(".my-2");
          const lastMessage = messages[messages.length - 1];
          if (lastMessage) {
            // Add sent indicator
            const statusDiv = document.createElement("div");
            statusDiv.className = "text-xs opacity-60 text-right";
            statusDiv.textContent = "Sent";
            lastMessage.querySelector(".max-w-[75%]").appendChild(statusDiv);
          }

          // Update conversation
          currentConversation.lastMessage = text;
          currentConversation.lastMessageTime = new Date().toISOString();
          renderConversations();
        } catch (error) {
          showToast("Failed to send message", "error");
        }
      }

      // ========================
      // AI CHAT FUNCTIONS
      // ========================
      function openAIChat() {
        if (!DOM.aiChat) return;

        DOM.aiChat.style.display = "flex";
        setTimeout(() => {
          if (DOM.aiInput) DOM.aiInput.focus();
        }, 100);
      }

      function closeAIChat() {
        if (DOM.aiChat) DOM.aiChat.style.display = "none";
      }

      function addAIMessage(text, sender) {
        if (!DOM.aiMessages) return;

        const messageDiv = document.createElement("div");
        messageDiv.className = `ai-message ${sender}-message`;
        messageDiv.innerHTML = `<span class="ai-message-content">${text}</span>`;
        DOM.aiMessages.appendChild(messageDiv);
        DOM.aiMessages.scrollTop = DOM.aiMessages.scrollHeight;
      }

      async function sendAIMessage() {
        if (!DOM.aiInput) return;

        const message = DOM.aiInput.value.trim();
        if (!message) return;

        // Add user message to chat
        addAIMessage(message, "user");
        DOM.aiInput.value = "";

        try {
          // Get AI response
          const response = await fetch(`${API_BASE}/ai/chat`, {
            method: "POST",
            headers: {
              Authorization: `Bearer ${userToken}`,
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              message,
              context: {
                capsules: capsules.map((c) => c.name),
                user: currentUser,
              },
            }),
          });

          if (!response.ok) throw new Error("AI response failed");

          const data = await response.json();
          addAIMessage(data.response, "assistant");
        } catch (error) {
          // Simulate a response if AI is offline
          setTimeout(() => {
            const responses = [
              "I can help you create and manage your time capsules. What type of memory would you like to preserve?",
              "As your quantum assistant, I specialize in temporal memory preservation. How can I assist you?",
              "I've analyzed your capsule patterns. Would you like me to suggest capsule themes based on your preferences?",
            ];
            addAIMessage(
              responses[Math.floor(Math.random() * responses.length)],
              "assistant"
            );
          }, 1000);
        }
      }

      // ========================
      // REALTIME COMMUNICATION
      // ========================
      function initQuantumSocket() {
        if (!window.io) {
          console.error("Socket.io not loaded");
          return;
        }

        socket = io(API_BASE, {
          auth: {
            token: userToken,
          },
        });

        socket.on("connect", () => {
          console.log("Connected to Quantum Network");
        });

        socket.on("capsule_created", (newCapsule) => {
          capsules.push(newCapsule);
          renderCapsules();
          updateDashboard();
          showToast(`New capsule created: ${newCapsule.name}`, "info");
        });

        socket.on("capsule_unlocked", (updatedCapsule) => {
          const index = capsules.findIndex((c) => c._id === updatedCapsule._id);
          if (index !== -1) {
            capsules[index] = updatedCapsule;
            renderCapsules();
            showToast(`Capsule unlocked: ${updatedCapsule.name}`, "success");
          }
        });

        socket.on("new_message", (data) => {
          const conversation = conversations.find(
            (c) => c.id === data.conversationId
          );
          if (conversation) {
            conversation.messages.push(data.message);
            conversation.lastMessage = data.message.text;
            conversation.lastMessageTime = data.message.time;

            if (currentConversation?.id === data.conversationId) {
              addMessageToChat(data.message);
            } else {
              conversation.unread = (conversation.unread || 0) + 1;
              renderConversations();
              showToast(`New message from ${conversation.name}`);
            }
          }
        });
      }

      // ========================
      // UTILITY FUNCTIONS
      // ========================
      function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString("en-US", {
          month: "short",
          day: "numeric",
          year: "numeric",
        });
      }

      function formatTime(dateString) {
        const date = new Date(dateString);
        return date.toLocaleTimeString([], {
          hour: "2-digit",
          minute: "2-digit",
          hour12: true,
        });
      }

      function showToast(message, type = "info") {
        if (!DOM.toastContainer) return;

        const colors = {
          success: "success",
          error: "error",
          info: "info",
        };

        const toast = document.createElement("div");
        toast.className = `toast ${colors[type]}`;
        toast.textContent = message;
        DOM.toastContainer.appendChild(toast);

        setTimeout(() => toast.classList.add("show"), 10);

        setTimeout(() => {
          toast.classList.remove("show");
          setTimeout(() => toast.remove(), 300);
        }, 5000);
      }

      // Initialize theme selector highlighting
      const savedTheme = localStorage.getItem("theme") || "dark-theme";
      document.querySelectorAll(".theme-option").forEach((option) => {
        if (option.dataset.theme === savedTheme) {
          option.classList.add("active");
        }
      });

      // Initialize the app when DOM is loaded
      document.addEventListener("DOMContentLoaded", () => {
        initializeDOM();
        setupEventListeners();

        // Check if we have existing session
        checkExistingSession();
      });
    </script>
  </body>
</html>
